{% extends 'base/base.html' %}
{% load static %}

{% block title %}
  {{ post.title }}
{% endblock %}

{% block content %}
  <!-- Container -->
  <div class="container w-full md:max-w-3xl mx-auto pt-20">
    <div class="w-full px-4 md:px-6 text-xl text-gray-800 leading-normal">
      <!-- Title -->
      <div class="font-sans">
        <h1 class="font-bold font-sans break-normal text-gray-900 pt-6 pb-2 text-3xl md:text-4xl">{{ post.title }}</h1>
        <p class="text-sm md:text-base font-normal text-gray-600">Published {{ post.created_at }}</p>
      </div>

      <!-- Author -->
      <div class="flex w-full items-center font-sans px-4 py-12">
        <a href="{% url 'profile' post.author.profile.id %}">
          <img class="w-16 h-16 rounded-full mr-4" src="{{ post.author.profile.avatar.url }}" alt="Avatar of Author"/>
        </a>
        <div class="flex-1 px-2">
          <a href="{% url 'profile' post.author.profile.id %}">
            <p class="text-base font-bold text-base md:text-xl leading-none mb-2">{{ post.author }}</p>
          </a>
          <p class="text-gray-600 text-xs md:text-base">bio's author</p>
        </div>
        <div class="justify-end">
          <button class="bg-transparent border border-gray-500 hover:border-green-500 text-xs text-gray-500 hover:text-green-500 font-bold py-2 px-4 rounded-full">
            Read More
          </button>
        </div>
      </div>
      <!-- /Author -->

      <!-- Post Content -->
      <div class="py-6">{{ post.content|safe }}</div>

      <!-- / Post Content -->
    </div>

    <!-- Tags -->
    <div class="text-base md:text-sm text-gray-500 px-4 py-6">
      Tags: <a href="#" class="text-base md:text-sm text-green-500 no-underline hover:underline">{{ post.category }}</a>
    </div>

    <!-- Divider -->
    <hr class="border-b-2 border-gray-400 mb-8 mx-4"/>

    <!-- Comment Section -->
    <div class="container w-full md:max-w-3xl mx-auto pt-8">
      <h2 class="text-2xl font-bold text-gray-900 px-4">Comments</h2>

      <!-- Comment Form -->
      <div class="mt-6 px-4">
        <input type="hidden" name="post_id" value="{{ post.id }}"/>
        <input type="hidden" name="user_id" value="{{ user.id }}"/>
        <textarea name="comment-content" id="comment-content"
                  class="w-full border border-gray-300 rounded-lg p-4 focus:outline-none focus:border-green-500"
                  rows="4" placeholder="Write your comment here..."></textarea>
        <button type="submit" id="btn-submit-comment"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 mt-4 rounded-lg">Post Comment
        </button>
      </div>

      <script type="text/javascript" data-post-id="{{ post.id }}" data-user-id="{{ user.id }}">
          $(document).ready(function () {
              $('#btn-submit-comment').on("click", function () {
                  const postId = "{{ post.id }}";
                  const userId = "{{ user.id }}";
                  const txtComment = $('#comment-content').val();
                  if (!txtComment.trim()) {
                      alert("Comment content cannot be empty!");
                      return;
                  }
                  $.ajax({
                      type: 'GET',
                      url: "{% url 'posts:post_comment' post.id %}",
                      data: {
                          csrfmiddlewaretoken: "{{ csrf_token }}",
                          post_id: postId,
                          user_id: userId,
                          comment_content: txtComment,
                      },
                      success: function (data) {
                          const newComment = `
                                <div class="flex mb-6">
                                  <img class="w-14 h-14 rounded-full mr-4" src="${data.avatar}" alt="Avatar of User"/>
                                  <div class="flex-1">
                                    <p class="text-green-600 font-normal">${data.username}</p>
                                    <p class="text-gray-600 text-sm mb-2">Posted on ${data.created_at}</p>
                                    <p class="text-gray-800">${data.content}</p>
                                  </div>
                                </div>
                                `;
                          $('#comments-section').prepend(newComment);
                          $('#comment-content').val('');

                      },
                      error: function (xhr, status, error) {
                          console.error("Error posting comment:", error);
                          alert("Failed to post comment. Please try again.");
                      }
                  });
              });
          });
      </script>

      <!-- Comment List -->
      <div class="mt-10 px-4">
        <!-- Single Comment -->

        <div class="comments-section" id="comments-section">
          {% for comment in post.comments.all %}
            <div class="flex mb-6">
              <img class="w-14 h-14 rounded-full mr-4" src="{{ comment.user.profile.avatar.url }}"
                   alt="Avatar of User"/>
              <div class="flex-1">
                <p class="text-green-600 font-normal">{{ post.author }}</p>
                <p class="text-gray-600 text-sm mb-2">Posted on {{ comment.created_at }}</p>
                <p class="text-gray-800">{{ comment.content }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <!-- /container -->
{% endblock %}
